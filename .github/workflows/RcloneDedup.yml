name: RClone Deduplication

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (simulate without deleting)'
        required: false
        default: true
        type: boolean
      incremental:
        description: 'Incremental mode (only process movie codes with recent changes)'
        required: false
        default: false
        type: boolean
      years:
        description: 'Comma-separated list of years to process (e.g., "2025,2026"). Leave empty for all years.'
        required: false
        default: ''
        type: string
      workers:
        description: 'Number of parallel workers'
        required: false
        default: '4'
        type: string
      log_level:
        description: 'Logging level'
        required: false
        default: 'INFO'
        type: choice
        options:
          - 'DEBUG'
          - 'INFO'
          - 'WARNING'
          - 'ERROR'
      runner:
        description: 'Runner type for the job'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'ubuntu-latest'
          - 'self-hosted'

jobs:
  # =============================================================================
  # Job: RClone Deduplication
  # =============================================================================
  dedup:
    runs-on: ${{ inputs.runner }}
    environment: Production
    permissions:
      contents: read
      actions: read
    env:
      TZ: Asia/Singapore
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust_core/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('rust_core/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install maturin
          pip install -r requirements.txt
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Try to download pre-built Rust extension wheel
        id: download_wheel
        continue-on-error: true
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          SANITIZED_BRANCH=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARTIFACT_NAME="rust-extension-wheel-latest-${SANITIZED_BRANCH}"
          
          echo "Attempting to download pre-built Rust extension wheel for branch: $BRANCH..."
          
          ENCODED_BRANCH=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BRANCH', safe=''))")
          WORKFLOW_RUN=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/actions/workflows/build-rust-extension.yml/runs?status=success&branch=${ENCODED_BRANCH}&per_page=1" \
            | jq -r '.workflow_runs[0].id // empty')
          
          if [ -z "$WORKFLOW_RUN" ] || [ "$WORKFLOW_RUN" == "null" ]; then
            echo "No successful build-rust-extension workflow run found for branch: $BRANCH"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found workflow run: $WORKFLOW_RUN"
          
          ARTIFACT_ID=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/actions/runs/$WORKFLOW_RUN/artifacts" \
            | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id // empty")
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "Artifact '$ARTIFACT_NAME' not found"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found artifact ID: $ARTIFACT_ID"
          
          mkdir -p rust_core/dist
          curl -L -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/artifacts/$ARTIFACT_ID/zip" \
            -o /tmp/wheel.zip || {
            echo "Failed to download artifact"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          }
          
          unzip -q /tmp/wheel.zip -d rust_core/dist/ || {
            echo "Failed to extract wheel"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          }
          
          rm /tmp/wheel.zip
          
          if ls rust_core/dist/*.whl 1> /dev/null 2>&1; then
            echo "âœ“ Pre-built wheel downloaded successfully"
            echo "available=true" >> $GITHUB_OUTPUT
            ls -lh rust_core/dist/*.whl
          else
            echo "Wheel file not found after download"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust extension from wheel
        if: steps.download_wheel.outputs.available == 'true'
        run: |
          source .venv/bin/activate
          pip install rust_core/dist/*.whl
          echo "âœ“ Installed Rust extension from pre-built wheel"

      - name: Build and install Rust extension from source (fallback)
        if: steps.download_wheel.outputs.available != 'true'
        working-directory: rust_core
        run: |
          echo "Pre-built wheel not available, building from source..."
          maturin develop --release
          echo "âœ“ Built and installed Rust extension from source"

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          echo "âœ“ rclone configured"
          rclone listremotes

      - name: Validate environment variables
        env:
          DRIVE_NAME: ${{ secrets.RCLONE_DRIVE_NAME }}
          ROOT_FOLDER: ${{ secrets.RCLONE_ROOT_FOLDER }}
        run: |
          if [ -z "$DRIVE_NAME" ]; then
            echo "âŒ Error: RCLONE_DRIVE_NAME secret is not set"
            exit 1
          fi
          if [ -z "$ROOT_FOLDER" ]; then
            echo "âŒ Error: RCLONE_ROOT_FOLDER secret is not set"
            exit 1
          fi
          echo "âœ“ DRIVE_NAME: $DRIVE_NAME"
          echo "âœ“ ROOT_FOLDER: $ROOT_FOLDER"

      - name: Run Deduplication Script
        env:
          DRIVE_NAME: ${{ secrets.RCLONE_DRIVE_NAME }}
          ROOT_FOLDER: ${{ secrets.RCLONE_ROOT_FOLDER }}
        run: |
          set -e  # Exit on error
          set -o pipefail  # Exit on error in pipeline
          
          # Build command arguments
          ARGS=""
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
            echo "ðŸ” Running in DRY-RUN mode (no files will be deleted)"
          else
            echo "âš ï¸ Running in LIVE mode (files will be deleted)"
          fi
          
          if [ "${{ inputs.incremental }}" = "true" ]; then
            ARGS="$ARGS --incremental"
            echo "ðŸ“… Incremental mode enabled (only recent changes)"
          fi
          
          if [ -n "${{ inputs.years }}" ]; then
            ARGS="$ARGS --years ${{ inputs.years }}"
            echo "ðŸ“† Year filter: ${{ inputs.years }}"
          fi
          
          python scripts/rclone_dedup.py \
            "$DRIVE_NAME" \
            "$ROOT_FOLDER" \
            $ARGS \
            --workers ${{ inputs.workers }} \
            --log-level ${{ inputs.log_level }}

      - name: Upload Dedup Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dedup-report-${{ github.run_number }}
          path: reports/Dedup/
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## Deduplication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.dry_run == 'true' && 'DRY-RUN' || 'LIVE' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Incremental**: ${{ inputs.incremental == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.years }}" ]; then
            echo "- **Year Filter**: ${{ inputs.years }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Workers**: ${{ inputs.workers }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Log Level**: ${{ inputs.log_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "reports/Dedup" ]; then
            REPORT_FILE=$(find reports/Dedup -name "*.csv" -type f | sort -r | head -1)
            if [ -n "$REPORT_FILE" ]; then
              echo "### Report Generated" >> $GITHUB_STEP_SUMMARY
              echo "Report file: \`$REPORT_FILE\`" >> $GITHUB_STEP_SUMMARY
              LINES=$(wc -l < "$REPORT_FILE")
              echo "Records: $((LINES - 1))" >> $GITHUB_STEP_SUMMARY
            fi
          fi
